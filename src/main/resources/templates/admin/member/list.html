<!DOCTYPE html>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원목록</title>
    <link rel="stylesheet" th:href="@{/css/admin/style_admin_common.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/style_admin_member_list.css}" />
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  </head>
  <body>
  <header th:replace="~{/admin/include/header.html}"></header>
    <main>
      <div id="wrapper">
        <aside th:replace="~{/admin/include/aside.html}"></aside>
        <section>
          <div class="breadcrumb">
            <a href="#">Home</a> > <a href="#">회원관리</a> >
            <a href="#" class="location">회원목록</a>
          </div>
          <h3>회원목록</h3>
          <div class="form">
            <div class="search-bar">
              <form action="#" th:action="@{/admin/member/list}" method="get"> <!-- GET 방식으로 폼 전송 -->
                <select id="search-category" name="searchCategory" class="dropdown"> <!-- name 속성 추가 -->
                  <option value="uid" th:selected="${searchCategory == 'uid'}">아이디</option>
                  <option value="name" th:selected="${searchCategory == 'name'}">이름</option>
                  <option value="email" th:selected="${searchCategory == 'email'}">이메일</option>
                  <option value="hp" th:selected="${searchCategory == 'hp'}">휴대폰</option>
                </select>
                <input
                        type="text"
                        name="keyword"
                        placeholder="키워드 입력"
                        class="search-input"
                        th:value="${keyword}"
                />
                <button type="submit" class="search-btn">검색</button> <!-- type을 submit으로 설정 -->
              </form>
            </div>


            <table class="inquiry-table">
              <colgroup>
                <col style="width: 5%" />
                <col style="width: 7%" />
                <col style="width: 6%" />
                <col style="width: 5%" />
                <col style="width: 6%" />
                <col style="width: 6%" />
                <col style="width: 13%" />
                <!--<col style="width: 9%" />-->
                <col style="width: 10%" />
                <col style="width: 5%" />
                <col style="width: 7%" />
              </colgroup>
              <thead>
                <tr>
                  <th>번호</th>
                  <th>아이디</th>
                  <th>이름</th>
                  <th>성별</th>
                  <th>등급</th>
                  <th>포인트</th>
                  <th>이메일</th>
                  <!--<th>휴대폰</th>-->
                  <th>가입일</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody>
              <tr th:each="user, i : ${userList}">
                <td th:text="${startNo - i.index}"></td>
                <td>[[${user.uid}]]</td>
                  <td>[[${user.memberInfo.name}]]</td>
                  <td>[[${user.memberInfo.gender == 0 ? 'M' : 'F'}]]</td>
                <td>
                  <select name="grade" class="grade">
                    <option value="VVIP" th:selected="${user.memberInfo.grade == 'VVIP'}">VVIP</option>
                    <option value="VIP" th:selected="${user.memberInfo.grade == 'VIP'}">VIP</option>
                    <option value="GOLD" th:selected="${user.memberInfo.grade == 'GOLD'}">GOLD</option>
                    <option value="SILVER" th:selected="${user.memberInfo.grade == 'SILVER'}">SILVER</option>
                    <option value="FAMILY" th:selected="${user.memberInfo.grade == 'FAMILY'}">FAMILY</option>
                  </select>
                </td>

                <td>[[${user.memberInfo.point}]]</td>
                  <td>[[${user.memberInfo.email}]]</td>
                  <!--<td>[[${user.memberInfo.hp}]]</td>-->
                <td th:text="${#strings.substring(user.memberInfo.updatedAt, 0, 19)}"></td>
                  <td class="userStatus normal">[[${user.memberInfo.status}]]</td>
                <td>
                  <a href="#" th:attr="data-uid=${user.uid}" class="edit-btn">수정</a><br />
                  <button class="deletebtn">중지</button>
                </td>
              </tr>
              </tbody>
            </table>
            <div class="pagination">
              <button class="page-btn"
                      th:disabled="${currentPage == 0}"
                      th:onclick="'window.location.href=\'?page=' + ${currentPage - 1} + '&size=5\''">
                이전
              </button>
              <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                        <button class="page-num"
                                th:classappend="${i == currentPage} ? 'active'"
                                th:onclick="'window.location.href=\'?page=' + ${i} + '&size=5\''"
                                th:text="${i + 1}">1</button>
                    </span>
              <button class="page-btn"
                      th:disabled="${currentPage + 1 == totalPages}"
                      th:onclick="'window.location.href=\'?page=' + ${currentPage + 1} + '&size=5\''">
                다음
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>
    <div id="versionRegisterModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h4>회원수정</h4>
          <span id="registerModalClose" class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="versionRegisterForm">
            <table class="modal-table">
              <tr>
                <th>아이디</th>
                <td id="userId" class="modalUid">

                </td>
              </tr>
              <tr>
                <th>이름</th>
                <td>
                  <input
                    type="text"
                    id="userName"
                    name="name"
                    placeholder="#유저이름"
                    required
                  />
                </td>
              </tr>
              <tr>
                <th>성별</th>
                <td>
                  <input type="radio" class="modal_sex" name="gender" value="0" />남
                  <input type="radio" class="modal_sex" name="gender" value="1" />여
                </td>
              </tr>
              <tr>
                <th>등급</th>
                <td>
                  <input
                    type="text"
                    id="userGrade"
                    name="grade"
                    placeholder="#유저등급"
                    required
                    readonly
                  />
                  &nbsp;등급 수정은 회원 목록에서 선택수정 가능
                </td>
              </tr>
              <tr></tr>
              <tr>
                <th>상태</th>
                <td id="userStatus"></td>
              </tr>
              <tr>
                <th>EMAIL</th>
                <td>
                  <input
                    type="text"
                    id="userEmail"
                    name="email"
                    placeholder="#유저이메일"
                    required
                  />
                </td>
              </tr>
              <tr>
                <th>휴대폰</th>
                <td>
                  <input
                    type="text"
                    id="userHp"
                    name="hp"
                    placeholder="#유저휴대폰"
                    required
                  />
                </td>
              </tr>
              <tr>
                <th>우편번호</th>
                <td>
                  <input
                    type="text"
                    id="userZipcode"
                    name="zipCode"
                    placeholder="#유저우편번호"
                    required
                  />
                  <button type="button" id="btnZip" class="register-btns">우편번호 찾기</button>
                </td>
              </tr>
              <tr>
                <th>기본주소</th>
                <td>
                  <input
                    type="text"
                    id="userAddr1"
                    name="addr1"
                    placeholder="#유저기본주소"
                    required
                  />
                </td>
              </tr>
              <tr>
                <th>상세주소</th>
                <td>
                  <input
                    type="text"
                    id="userAddr2"
                    name="addr2"
                    placeholder="#유저상세주소"
                    required
                  />
                </td>
              </tr>
              <tr>
                <th>가입일</th>
                <td id="userUpdatedAt"></td>
              </tr>
              <tr>
                <th>최근로그인날짜</th>
                <td id="userLastLoginAt"></td>
              </tr>
              <tr>
                <th>기타</th>
                <td>
                  <textarea
                    name="etc"
                    id="etc"
                    placeholder="회원에대한기타정보입력"
                  ></textarea>
                </td>
              </tr>
            </table>
          </form>
        </div>
        <div class="modal-footer">
          <button class="confirm-btn">수정하기</button>
        </div>
      </div>
    </div>
  <footer th:replace="~{/admin/include/footer.html}"></footer>

  <script>

    // 우편번호 검색 기능
    document.getElementById('btnZip').onclick = function () {
      new daum.Postcode({
        oncomplete: function (data) {
          document.getElementById('userZipcode').value = data.zonecode;
          document.getElementById('userAddr1').value = data.roadAddress || data.jibunAddress;
          document.getElementById('userAddr2').focus();
        }
      }).open();
    };

    // 회원 수정 모달 동작
    window.onload = function() {
      const registerModal = document.getElementById("versionRegisterModal");
      const registerCloseBtn = document.getElementById("registerModalClose");
      const confirmButton = document.querySelector(".confirm-btn");

      // 수정 버튼 클릭 시 모달 열기 및 정보 조회
      const editBtns = document.querySelectorAll(".edit-btn");
      editBtns.forEach(function(btn) {
        btn.onclick = function(event) {
          event.preventDefault(); // 기본 링크 동작 방지

          // UID 가져오기
          const uid = this.getAttribute('data-uid');
          console.log('uid:', uid);  // UID 값 확인

          // AJAX 요청으로 사용자 정보 조회
          fetch(`/lotteon/admin/member/list/${uid}`)  // 여기에 사용자의 정보를 가져오는 API 엔드포인트를 지정
                  .then(response => response.json())
                  .then(data => {
                    console.log('data : ', data);

                    // 사용자 정보가 성공적으로 가져와지면 모달에 채우기
                    document.getElementById("userId").textContent = data.uid; // 아이디
                    document.getElementById("userName").value = data.memberInfo.name; // 이름

                    // 성별 값에 따라 라디오 버튼 체크 (0: 남, 1: 여)
                    const gender = data.memberInfo.gender;
                    const genderRadios = document.querySelectorAll("input[name='gender']");
                    // 라디오 버튼 체크 상태 설정
                    genderRadios.forEach(radio => {
                      if (gender === 0 && radio.value === "0") {
                        radio.checked = true; // 남 체크
                      } else if (gender === 1 && radio.value === "1") {
                        radio.checked = true; // 여 체크
                      }
                    });

                    document.getElementById("userGrade").value = data.memberInfo.grade; // 등급
                    document.getElementById("userStatus").textContent = data.memberInfo.status; // 상태
                    document.getElementById("userEmail").value = data.memberInfo.email; // 이메일
                    document.getElementById("userHp").value = data.memberInfo.hp; // 휴대폰
                    document.getElementById("userZipcode").value = data.memberInfo.address.zipCode; // 우편번호
                    document.getElementById("userAddr1").value = data.memberInfo.address.addr1; // 기본주소
                    document.getElementById("userAddr2").value = data.memberInfo.address.addr2; // 상세주소
                    const updatedAt = data.memberInfo.updatedAt;  // 가입일
                    const formattedDate = updatedAt.substring(0, 19);
                    document.getElementById("userUpdatedAt").textContent = formattedDate;
                    document.getElementById("userLastLoginAt").textContent = data.memberInfo.lastLoginAt; // 최근로그인날짜
                    document.getElementById("etc").value = data.memberInfo.etc;

                    // 모달 열기
                    registerModal.style.display = "block";
                  })
                  .catch(error => {
                    console.error('Error fetching user data:', error);
                  });
        };
      });

      // 모달 닫기 버튼
      registerCloseBtn.onclick = function() {
        registerModal.style.display = "none";
      };

      // 수정하기 버튼 클릭 시 처리
      confirmButton.onclick = function() {
        const updatedData = {
          uid: document.getElementById("userId").value,
          name: document.getElementById("userName").value,
          gender: document.querySelector("input[name='gender']:checked").value,
          email: document.getElementById("userEmail").value,
          hp: document.getElementById("userHp").value,
          zipCode: document.getElementById("userZipcode").value,
          addr1: document.getElementById("userAddr1").value,
          addr2: document.getElementById("userAddr2").value,
          // 필요시 다른 필드 추가
        };

        // AJAX로 수정 요청
        fetch(`/lotteon/admin/member/update`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedData),
        })
                .then(response => {
                  if (response.ok) {
                    alert("정상적으로 수정되었습니다.");
                    // 성공적으로 업데이트 후 모달 닫기
                    registerModal.style.display = "none";

                    location.reload(); // 페이지 새로 고침
                  } else {
                    // 에러 처리
                    console.error('Error updating user data:', response.statusText);
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                });
      };
    };
  </script>

  </body>
</html>
