<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>롯데ON::롯데 온라인 쇼핑몰</title>
    <link rel="shortcut icon" type="image/x-icon" href="../images/favicon.ico"/>
    <link rel="stylesheet" th:href="@{/css/product/product_common.css}"/>
    <link rel="stylesheet" th:href="@{/css/product/style_product_view.css}"/>
</head>
<body>
<div id="bannerTop" class="on">
    <article th:each="banner : ${banners}" th:if="${banner.location == 'MAIN1'}" th:style="'background: ' + ${banner.background}">
        <a th:href="${banner.link}">
            <img th:src="@{'/uploads/config/' + ${banner.img}}" alt="랜덤 배너 이미지"/>
        </a>
    </article>
</div>
<div id="wrapper">
    <header th:replace="~{/include/header.html}"></header>

    <main class="mainIn cf">
        <aside th:replace="~{/main_aside.html}"></aside>
        <section class="product-view-section">
            <div class="breadcrumb">
                <a href="#">Home</a> &gt;
                <a href="#">패션·의류·뷰티</a> &gt;
                <a href="#">남성의류</a>
            </div>

            <h2 class="section-title">상품보기</h2>
            <section class="product-view">
                <div class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg1()}}" alt="상품 목록 사진" class="product-image">
                </div>
                <div class="product-info">
                    <p class="product-number">상품번호: 10010118412</p>
                    <h2 class="product-title" th:text="${productDTO.name}"></h2>
                    <p class="product-number" th:text="${productDTO.description}"></p>
                    <h2 id="product-dto" th:text="${productDTOJson}" style="display:none"></h2>
                    <div class="rating">
                        <span>★★★★★</span> <a href="#">상품리뷰</a> ([[${productDTO.review}]])
                    </div>
                    <div class="price-section">
                        <span class="original-price" th:text="${productDTO.price}"></span>
                        <span class="discount-rate" th:text="${productDTO.discount + '% ↓'}"></span>
                        <span class="discount-price">27,000원</span>
                    </div>
                    <div class="shipping-info">
                        <p th:if="${productDTO.deliveryFee == 0}" th:text="무료배송"></p>
                        <p th:if="${productDTO.deliveryFee != 0}" th:text="${productDTO.deliveryFee + '원'}"></p>
                        <p>모레(금) 7/8 도착 예정</p>
                    </div>
                    <div class="product-origin">
                        <p>원산지: 상세설명 참조</p>
                    </div>
                    <span id="variant-options" class="variant-options">
                       <ul>
                            <li th:each="entry : ${options.entrySet()}">
                                <span th:text="${entry.key}"></span>
                                <select class="option-select">
                                    <option value="" selected disabled>선택하세요</option>
                                    <option th:each="value : ${entry.value}" th:value="${value}" th:text="${value}"></option>
                                </select>
                            </li>
                        </ul>

                    </span>
                    <div class="quantity-section">
                        <label for="quantity">수량</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1"/>
                    </div>
                    <div class="total-price">
                        총 상품금액: <strong>27,000원</strong>
                    </div>
                    <div class="purchase-actions">
                        <form th:action="@{/product/cart}" method="post" id="cartForm">
                            <input type="hidden" name="productVariants" class="selected-variant-id"/>
                            <input type="hidden" name="count" id="count" />
                            <button type="submit" class="cart-button">장바구니</button>
                        </form>
                        <a th:href="@{/product/order}" class="buy-button">구매하기</a>
                    </div>
                    <div class="product-banner" th:each="banner : ${banners}" th:if="${banner.location == 'PRODUCT1'}">
                        <a th:href="${banner.link}">
                            <img th:src="@{'/uploads/config/' + ${banner.img}}" alt="랜덤 배너 이미지"/>
                        </a>
                    </div>
                </div>
            </section>

            <section class="product-details">
                <h3>상품정보</h3>
                <div class="product-detail-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg2()}}" alt="상품 메인 사진" class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg3()}}" alt="상품 상세 사진" class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getDetail()}}" alt="상품 상세 정보 사진" class="product-image">
                </div>
                <div id="product-info-public-announcement" class="hidden">
                    <h3>상품정보제공공시</h3>
                    <table class="info-table">
                        <tr>
                            <th>상품명</th>
                            <td>내셔널지오그래픽키즈 벨루가 헤비다운</td>
                        </tr>
                        <!-- Additional product info -->
                    </table>
                </div>
            </section>

            <!-- 상품리뷰 -->
            <section id="additional-product-info">
                <h3>상품리뷰</h3>

                <div class="review-list">
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-author">작성자: kko*****</span>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-content">
                            <p>적극추천 합니다. 배송이 빠릅니다.</p>
                            <span class="review-date">2024.10.09</span>
                        </div>
                    </div>
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-author">작성자: kko*****</span>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-content">
                            <p>적극추천 합니다. 배송이 빠릅니다.</p>
                            <span class="review-date">2024.10.09</span>
                        </div>
                    </div>
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-author">작성자: kko*****</span>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-content">
                            <p>적극추천 합니다. 배송이 빠릅니다.</p>
                            <span class="review-date">2024.10.09</span>
                        </div>
                    </div>
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-author">작성자: kko*****</span>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-content">
                            <p>적극추천 합니다. 배송이 빠릅니다.</p>
                            <span class="review-date">2024.10.09</span>
                        </div>
                    </div>     <div class="review-item">
                    <div class="review-header">
                        <span class="review-author">작성자: kko*****</span>
                    </div>
                    <div class="review-rating">★★★★★</div>
                    <div class="review-content">
                        <p>적극추천 합니다. 배송이 빠릅니다.</p>
                        <span class="review-date">2024.10.09</span>
                    </div>
                </div>
                    <div class="pagination">
                        <ul>
                            <li><a href="#">&lt;</a></li>
                            <li><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                            <li><a href="#">4</a></li>
                            <li><a href="#">5</a></li>
                            <li><a href="#">&gt;</a></li>
                        </ul>
                    </div>
                </div>
            </section>
        </section>
    </main>
    <footer th:replace="~{/include/footer.html}"></footer>
    <button type="button" id="top">상단이동</button>
</div>


<script>

    document.getElementById('cartForm').onsubmit = function(event) {
        event.preventDefault(); // 기본 폼 제출 방지

        // AJAX 요청
        const formData = new FormData(this);
        console.log('formData : ' + formData);
        fetch(this.action, {
            method: 'POST',
            body: formData,
        })
            .then(response => response.text())
            .then(data => {
                if (data === "success") {
                    // 성공 시 알림창 띄우기
                    if (confirm("장바구니에 상품이 담겼습니다. 장바구니로 이동하시겠습니까?")) {
                        window.location.href = "/lotteon/product/cart"; // 장바구니 페이지로 리다이렉트
                    }
                } else if (data === "failed") {
                    alert("장바구니 등록에 실패했습니다.");
                } else if (data === "noUser") {
                    alert("로그인이 필요합니다."); // 로그인 필요 알림
                    window.location.href = "/lotteon/member/login"; // 로그인 페이지로 리다이렉트
                }
            })
            .catch(error => console.error('Error:', error));
    };

    document.addEventListener('DOMContentLoaded', function() {

        // 수량이 변경될 때마다 count 필드에 값 업데이트
        document.getElementById('quantity').addEventListener('input', function () {
            document.getElementById('count').value = this.value;
        });

        // 페이지 로드 시 초기 수량 값 설정
        document.getElementById('count').value = document.getElementById('quantity').value;

        const productDataElement = document.getElementById('product-dto');
        const productDTO = JSON.parse(productDataElement.textContent);

        console.log("Loaded productDTO:", productDTO); // 전체 productDTO 객체 확인

        const selects = document.querySelectorAll('#variant-options select');

        function findMatchingVariant() {
            // 선택된 옵션을 배열에 담음
            const selectedOptions = [];
            selects.forEach(select => {
                selectedOptions.push(select.value);
            });
            console.log("Selected Options Array:", selectedOptions);

            // 옵션의 키를 생성
            let selectedOptionsKey = `[${Array.from(selects).map(select => select.previousElementSibling.innerText.replace(':', '').trim()).join(', ')}]`;
            console.log("Generated Key for Selected Options (original):", selectedOptionsKey);

            // 순열 생성 함수
            function generatePermutations(array) {
                if (array.length <= 1) return [array];
                const permutations = [];
                for (let i = 0; i < array.length; i++) {
                    const currentElement = array[i];
                    const remainingElements = array.slice(0, i).concat(array.slice(i + 1));
                    const remainingPermutations = generatePermutations(remainingElements);
                    remainingPermutations.forEach(permutation => {
                        permutations.push([currentElement, ...permutation]);
                    });
                }
                return permutations;
            }

            // 모든 순열 생성
            const optionsPermutations = generatePermutations(selectedOptions);
            const keysPermutations = generatePermutations(Array.from(selects).map(select => select.previousElementSibling.innerText.replace(':', '').trim()));

            console.log("All Options Permutations:", optionsPermutations);
            console.log("All Keys Permutations:", keysPermutations);

            let matchingVariant = null;

            if (selectedOptions.every(value => value)) {
                // 각 키와 옵션 배열의 모든 순열로 variant 찾기
                for (let keyPerm of keysPermutations) {
                    selectedOptionsKey = `[${keyPerm.join(', ')}]`;
                    console.log("Trying Key Permutation:", selectedOptionsKey);

                    for (let optionsPerm of optionsPermutations) {
                        console.log("Trying Options Permutation:", optionsPerm);

                        matchingVariant = productDTO.productVariants.find(variant => {
                            const variantOptions = variant.options[selectedOptionsKey];
                            console.log("Checking variant:", variant.variant_id, "with options:", variantOptions, "against selected options:", optionsPerm);
                            return JSON.stringify(variantOptions) === JSON.stringify(optionsPerm);
                        });

                        if (matchingVariant) {
                            console.log("Match found with Key:", selectedOptionsKey, "and Options:", optionsPerm);
                            break; // 매칭이 되면 더 이상 반복하지 않음
                        }
                    }
                    if (matchingVariant) break;
                }
            }

            if (matchingVariant) {
                console.log("Matched Variant ID:", matchingVariant.variant_id);
                document.querySelector('.selected-variant-id').value = matchingVariant.variant_id;
            } else {
                console.log("No matching variant found");
                document.querySelector('.selected-variant-id').value = "선택된 Variant ID: 없음";
            }
        }

        selects.forEach(select => {
            select.addEventListener('change', findMatchingVariant);
        });

    });
</script>
</body>
</html>