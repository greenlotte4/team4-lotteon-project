<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <th:block th:replace="~{/include/common_head}"></th:block>
    <link rel="shortcut icon" type="image/x-icon" href="../images/favicon.ico"/>
    <link rel="stylesheet" th:href="@{/css/product/product_common.css}"/>
    <link rel="stylesheet" th:href="@{/css/product/style_product_view.css}"/>
    <script th:src="@{/js/my/product/product_view.js}" defer></script>
</head>
<body>
<div id="bannerTop" class="on">
    <article th:each="banner : ${banners}" th:if="${banner.location == 'MAIN1'}" th:style="'background: ' + ${banner.background}">
        <a th:href="${banner.link}">
            <img th:src="@{'/uploads/config/' + ${banner.img}}" alt="랜덤 배너 이미지"/>
        </a>
    </article>
</div>
<div id="wrapper">
    <header th:replace="~{/include/header.html}"></header>

    <main class="mainIn cf">
        <aside th:replace="~{/main_aside.html}"></aside>
        <section class="product-view-section body-section">
            <div class="breadcrumb">
                <a href="#">Home</a> &gt;
                <a href="#">패션·의류·뷰티</a> &gt;
                <a href="#">남성의류</a>
            </div>

            <h2 class="section-title">상품보기</h2>
            <section class="product-view">
                <div class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg1()}}" alt="상품 목록 사진" class="product-image">
                </div>
                <div class="product-info">
                    <p class="product-number">상품번호: [[${productDTO.productId}]]</p>
                    <h2 class="product-title" th:text="${productDTO.name}"></h2>
                    <p class="product-number" th:text="${productDTO.description}"></p>
                    <h2 id="product-dto" th:text="${productDTOJson}" style="display:none"></h2>
                    <div class="rating">
                        <span>★★★★★</span> <a href="#">상품리뷰</a> ([[${productDTO.review}]])
                    </div>
                    <div class="price-section">
                        <span class="original-price" th:text="${productDTO.price}" th:attr="data-originalPrice=${productDTO.price}"></span>
                        <span class="discount-rate" th:text="${productDTO.discount + '% ↓'}" th:attr="data-discountRate=${productDTO.discount}"></span>
                        <span class="discount-price"></span>
                    </div>
                    <div class="shipping-info">
                        <p th:if="${productDTO.deliveryFee == 0}" th:text="무료배송"></p>
                        <p th:if="${productDTO.deliveryFee != 0}" th:text="${productDTO.deliveryFee + '원'}"></p>
                        <p>모레(금) 7/8 도착 예정</p>
                    </div>
                    <div class="product-origin">
                        <p>원산지 : 상세설명 참조</p>
                    </div>
                    <span id="variant-options" class="variant-options">
                       <ul>
                            <li th:each="entry, entryStat : ${options.entrySet()}">
                                <span th:text="${entry.key}"></span>
                                <select class="option-select">
                                    <option value="" selected disabled>선택하세요</option>
                                    <option th:each="value : ${entry.value}" th:value="${value}">[[${value}]]</option>
                                </select>
                            </li>
                        </ul>
                    </span>
                    <div class="total-price">
                        총 상품금액: <strong>0원</strong>
                    </div>
                    <div class="purchase-actions">
                        <form th:action="@{/product/cart}" method="post" id="cartForm">
                            <input type="hidden" name="productVariants" class="selected-variant-id"/>
                            <input type="hidden" name="count" id="count" />
                            <button type="submit" class="cart-button">장바구니</button>
                        </form>
                        <a id="buyLink" th:href="@{/product/order}" class="buy-button">구매하기</a>
                    </div>
                    <div class="product-banner" th:each="banner : ${banners}" th:if="${banner.location == 'PRODUCT1'}">
                        <a th:href="${banner.link}">
                            <img th:src="@{'/uploads/config/' + ${banner.img}}" alt="랜덤 배너 이미지"/>
                        </a>
                    </div>
                </div>
            </section>

            <section class="product-details">
                <h3>상품정보</h3>
                <div class="product-detail-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg2()}}" alt="상품 메인 사진" class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getImg3()}}" alt="상품 상세 사진" class="product-image">
                    <img th:src="@{'/uploads/product/' + ${productDTO.getDetail()}}" alt="상품 상세 정보 사진" class="product-image">
                </div>
                <div id="product-info-public-announcement" class="hidden">
                    <h3>상품정보제공공시</h3>
                    <table class="info-table">
                        <tr>
                            <th>상품상태</th>
                            <td th:text="${productDTO.productDetailId.condition_field}"></td>
                        </tr>
                        <tr>
                            <th>부가세 면세여부</th>
                            <td th:text="${productDTO.productDetailId.duty}"></td>
                        </tr>
                        <tr>
                            <th>영수증 발행</th>
                            <td th:text="${productDTO.productDetailId.receipt}"></td>
                        </tr>
                        <tr>
                            <th>사업자구분</th>
                            <td th:text="${productDTO.productDetailId.sellerType}"></td>
                        </tr>
                        <tr>
                            <th>브랜드</th>
                            <td th:text="${productDTO.productDetailId.brand}"></td>
                        </tr>
                        <tr>
                            <th>원산지</th>
                            <td th:text="${productDTO.productDetailId.coa}"></td>
                        </tr>
                        <tr>
                            <th>제조자 / 수입국</th>
                            <td th:text="${productDTO.productDetailId.creator}"></td>
                        </tr>
                        <tr>
                            <th>제조국</th>
                            <td th:text="${productDTO.productDetailId.country}"></td>
                        </tr>
                        <tr>
                            <th>취급시주의사항</th>
                            <td th:text="${productDTO.productDetailId.warning}"></td>
                        </tr>
                        <tr>
                            <th>제조연월</th>
                            <td th:text="${productDTO.productDetailId.createDate}"></td>
                        </tr>
                        <tr>
                            <th>품질보증기준</th>
                            <td th:text="${productDTO.productDetailId.quality}"></td>
                        </tr>
                        <tr>
                            <th>A/S 책임자</th>
                            <td th:text="${productDTO.productDetailId.as_field}"></td>
                        </tr>
                        <tr>
                            <th>전화번호</th>
                            <td th:text="${productDTO.productDetailId.asPhone}"></td>
                        </tr>
                        <!-- Additional product info -->
                    </table>
                </div>
            </section>

            <!-- 상품리뷰 -->
            <section id="additional-product-info" th:data-product-id="${productDTO.productId}">
                <h3>상품리뷰</h3>
                <div class="review-list" id="review-list">
                    <!-- 리뷰가 JavaScript로 추가될 부분 -->
                </div>
                <div class="pagination"></div>
            </section>

        </section>
    </main>
    <footer th:replace="~{/include/footer.html}"></footer>
</div>
<script>
    let currentPage = 0;
    const pageSize = 8;
    const prodId = document.getElementById("additional-product-info").dataset.productId;

    async function loadReviews(page = 0) {
        try {
            const response = await fetch(`/lotteon/review/${prodId}?page=${page}&size=${pageSize}`);
            const data = await response.json();

            if (response.ok) {
                renderReviews(data.content);
                updatePagination(data.totalPages, page); // 현재 페이지 정보 전달
                currentPage = page; // 현재 페이지 업데이트
            } else {
                console.error("리뷰를 불러오는 중 오류 발생:", data);
            }
        } catch (error) {
            console.error("리뷰를 불러오는 중 오류 발생:", error);
        }
    }

    function renderReviews(reviews) {
        const reviewList = document.getElementById("review-list");
        reviewList.innerHTML = ""; // 기존 리뷰 초기화

        if (!reviews || reviews.length === 0) {
            reviewList.innerHTML = "<p>리뷰가 없습니다.</p>";
            return;
        }

        reviews.forEach(review => {
            const reviewItem = document.createElement("div");
            reviewItem.classList.add("review-item");

            let starsHTML = '';
            for (let i = 0; i < Math.floor(review.rating / 2); i++) {
                starsHTML += '<img src="/lotteon/images/review/star.png" alt="Full Star" class="star">';
            }
            if (review.rating % 2 === 1) {
                starsHTML += '<img src="/lotteon/images/review/star_half.png" alt="Half Star" class="star">';
            }
            for (let i = 0; i < 5 - Math.floor(review.rating / 2) - (review.rating % 2 === 1 ? 1 : 0); i++) {
                starsHTML += '<img src="/lotteon/images/review/star_gray.png" alt="Gray Star" class="star">';
            }

            reviewItem.innerHTML = `
            <div class="review-header">
                <span class="review-author">${review.uid}</span>
                <span class="review-date">${review.regDate ? review.regDate : '등록일 없음'}</span>
            </div>
            <div class="review-rating">${starsHTML}</div>
            <div>
                <p class="review_content">${review.content}</p>
            </div>
            <div>
                ${review.img1 ? `<img class="review_img" src="/lotteon/uploads/review/${review.img1}" alt="리뷰 이미지1" class="review-image"/>` : ""}
                ${review.img2 ? `<img class="review_img" src="/lotteon/uploads/review/${review.img2}" alt="리뷰 이미지2" class="review-image"/>` : ""}
            </div>
        `;
            reviewList.appendChild(reviewItem);
        });
    }

    function updatePagination(totalPages, currentPage) {
        const paginationDiv = document.querySelector('.pagination');
        paginationDiv.innerHTML = ''; // 기존 버튼 초기화

        const prevButton = document.createElement('button');
        prevButton.classList.add('page-btn');
        prevButton.disabled = currentPage === 0;
        prevButton.textContent = '이전';
        prevButton.onclick = () => loadReviews(currentPage - 1);
        paginationDiv.appendChild(prevButton);

        for (let i = 0; i < totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.classList.add('page-num');
            if (i === currentPage) pageButton.classList.add('active');
            pageButton.textContent = i + 1;
            pageButton.onclick = () => loadReviews(i);
            paginationDiv.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.classList.add('page-btn');
        nextButton.disabled = currentPage + 1 === totalPages;
        nextButton.textContent = '다음';
        nextButton.onclick = () => loadReviews(currentPage + 1);
        paginationDiv.appendChild(nextButton);
    }

    // 초기 리뷰 로드
    document.addEventListener("DOMContentLoaded", () => loadReviews(currentPage));

</script>
</body>
</html>